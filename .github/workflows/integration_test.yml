name: Integration Tests

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  test-docker:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout repository
    - uses: actions/checkout@v3

    # 2. Build Docker Image
    - name: Build Docker Image
      run: |
        echo "[1/5] Building Docker image..."
        docker build -t app-test -f docker/Dockerfile.singlestage .
        echo "      [OK]"

    # 3. Run Docker Container
    - name: Run Docker Container
      run: |
        echo "[2/5] Starting Docker container..."
        docker run -d -p 3000:3000 --name test-container app-test
        echo "      [OK]"

    # 4. Wait for application startup
    - name: Wait for App to start
      run: |
        echo "[3/5] Waiting for application startup..."
        sleep 5
        echo "      [OK]"

    # 5. Verify endpoints
    - name: Verify Application Endpoints
      id: test_endpoints
      run: |
        echo "[4/5] Testing endpoints..."
        
        HTTP_ROOT=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:3000/)
        if [ "$HTTP_ROOT" = "200" ]; then
          echo "      Root endpoint (/) [OK]"
          echo "ROOT_STATUS=PASS" >> $GITHUB_ENV
        else
          echo "      Root endpoint (/) [FAIL]"
          echo "ROOT_STATUS=FAIL" >> $GITHUB_ENV
        fi
        
        HTTP_API=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:3000/api/50)
        if [ "$HTTP_API" = "200" ]; then
          echo "      API endpoint (/api/n) [OK]"
          echo "API_STATUS=PASS" >> $GITHUB_ENV
        else
          echo "      API endpoint (/api/n) [FAIL]"
          echo "API_STATUS=FAIL" >> $GITHUB_ENV
          exit 1
        fi

    # 6. Generate test report
    - name: Generate Test Report
      if: always()
      run: |
        echo "[5/5] Generating test report..."
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Test Case | Status |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
        if [ "$ROOT_STATUS" == "PASS" ]; then
             echo "| Infrastructure | Root Endpoint (/) | [OK] |" >> $GITHUB_STEP_SUMMARY
        else
             echo "| Infrastructure | Root Endpoint (/) | [FAIL] |" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "$API_STATUS" == "PASS" ]; then
             echo "| Infrastructure | API Endpoint (/api/n) | [OK] |" >> $GITHUB_STEP_SUMMARY
        else
             echo "| Infrastructure | API Endpoint (/api/n) | [FAIL] |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "      [OK]"
